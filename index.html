<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gestão | Portaria e Zeladoria</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* --- Paleta de Cores Moderna --- */
            --bg-body: #f3f4f6;
            --bg-sidebar: #1e293b;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-sidebar: #94a3b8;
            --text-sidebar-active: #ffffff;

            /* Cores Funcionais */
            --primary: #3b82f6;
            --accent: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            
            /* Cores Específicas de Domínio */
            --visitante: #8b5cf6;
            --servidor: #3b82f6;
            --recepcao: #14b8a6;
            --estacionado: #f97316;
            --evento: #ec4899;
            --excel: #16a34a;
            --coffee: #854d0e;
            --ocorrencia: #dc2626;

            /* Dimensões e Efeitos */
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 72px;
            --header-height: 64px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; }
        
        .uppercase-input { text-transform: uppercase; }
        input:not(.login-input)[type="text"], textarea:not(.login-input), input:not(.login-input)[type="text"]::placeholder, textarea:not(.login-input):::placeholder { text-transform: uppercase; }

        /* --- TELA DE LOGIN --- */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-card { background: white; width: 100%; max-width: 400px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden; animation: slideUp 0.4s ease-out; }
        .login-header { background: #f8fafc; padding: 30px 30px 20px; text-align: center; border-bottom: 1px solid #e2e8f0; }
        .logo-circle { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 15px; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .login-header h2 { color: var(--text-primary); font-size: 1.25rem; font-weight: 700; margin-bottom: 5px; }
        .login-header p { color: var(--text-secondary); font-size: 0.875rem; }
        .login-body { padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 8px; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper i.input-icon { position: absolute; left: 16px; color: #94a3b8; z-index: 10; }
        .login-input { width: 100%; padding: 12px 12px 12px 45px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; color: #334155; background: #fff; transition: all 0.2s; text-transform: none !important; }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        .toggle-pass { position: absolute; right: 12px; background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px; }
        .toggle-pass:hover { color: var(--primary); }
        .error-box { background-color: #fef2f2; border: 1px solid #fecaca; color: #ef4444; padding: 12px; border-radius: 8px; font-size: 0.85rem; display: none; align-items: center; gap: 8px; }
        .btn-login { width: 100%; background-color: var(--primary); color: white; font-weight: 600; padding: 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 1rem; transition: background 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-login:hover { background-color: var(--accent); transform: translateY(-1px); }
        .login-footer { text-align: center; padding: 20px; background: #f8fafc; border-top: 1px solid #e2e8f0; color: #94a3b8; font-size: 0.75rem; }

        /* --- LAYOUT SHELL --- */
        .app-sidebar { width: var(--sidebar-width); background-color: var(--bg-sidebar); height: 100vh; display: flex; flex-direction: column; transition: var(--transition); z-index: 50; flex-shrink: 0; position: relative; }
        .sidebar-header { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; color: white; font-weight: 700; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap; overflow: hidden; }
        .sidebar-header i { margin-right: 12px; color: var(--success); }
        .sidebar-nav { flex: 1; padding: 24px 12px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px 16px; color: var(--text-sidebar); text-decoration: none; border-radius: var(--radius-md); transition: var(--transition); cursor: pointer; border: none; background: transparent; font-family: inherit; font-size: 0.95rem; width: 100%; text-align: left; white-space: nowrap; }
        .nav-item i { width: 24px; text-align: center; margin-right: 12px; font-size: 1.1rem; transition: var(--transition); }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: var(--text-sidebar-active); }
        .nav-item.active { background-color: var(--primary); color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .user-profile { display: flex; align-items: center; gap: 12px; color: white; }
        .user-avatar { width: 36px; height: 36px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .app-main { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; transition: var(--transition); }
        .app-header { height: var(--header-height); background-color: var(--bg-card); border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 40; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .toggle-sidebar-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 8px; border-radius: 50%; transition: var(--transition); }
        .toggle-sidebar-btn:hover { background-color: #f3f4f6; color: var(--primary); }
        .page-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .header-right { display: flex; align-items: center; gap: 16px; font-size: 0.85rem; color: var(--text-secondary); }
        .content-area { flex: 1; overflow-y: auto; padding: 24px; scroll-behavior: smooth; }
        .container-limit { max-width: 1400px; margin: 0 auto; }

        /* --- COMPONENTES UI --- */
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 24px; border: 1px solid #e5e7eb; transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-md); }
        .card h2 { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }
        .dashboard-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .metric-card { background: white; padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent; transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .metric-info h3 { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px; }
        .metric-info p { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0; }
        .metric-icon { font-size: 2rem; opacity: 0.15; }
        
        /* Cores Cards Gerais */
        .card-total { border-left-color: var(--primary); } .card-total .metric-icon { color: var(--primary); }
        .card-pendente { border-left-color: var(--warning); } .card-pendente .metric-icon { color: var(--warning); }
        .card-andamento { border-left-color: var(--accent); } .card-andamento .metric-icon { color: var(--accent); }
        .card-concluido { border-left-color: var(--success); } .card-concluido .metric-icon { color: var(--success); }
        .card-recepcao { border-left-color: var(--recepcao); } .card-recepcao .metric-icon { color: var(--recepcao); }
        .card-estacionado { border-left-color: var(--estacionado); } .card-estacionado .metric-icon { color: var(--estacionado); }
        .card-ocorrencia { border-left-color: var(--ocorrencia); } .card-ocorrencia .metric-icon { color: var(--ocorrencia); }

        /* Eventos Cards (Cores Específicas) */
        .card-evt-total { border-left-color: #cbd5e1; } .card-evt-total .metric-icon { color: #cbd5e1; }
        .card-evt-interno { border-left-color: var(--primary); } .card-evt-interno .metric-icon { color: var(--primary); }
        .card-evt-externo { border-left-color: var(--evento); } .card-evt-externo .metric-icon { color: var(--evento); }
        .card-evt-publico { border-left-color: var(--success); } .card-evt-publico .metric-icon { color: var(--success); }

        /* Garagem Cards (Cores Específicas) */
        .card-servidor { border-left-color: #cbd5e1; } .card-servidor .metric-icon { color: #cbd5e1; }
        .card-visitante { border-left-color: #64748b; } .card-visitante .metric-icon { color: #64748b; }

        /* Forms e Tabelas */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 20px; }
        label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: var(--radius-md); font-size: 0.9rem; background-color: #f9fafb; transition: var(--transition); }
        input:focus, select:focus, textarea:focus { background-color: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn-container { display: flex; gap: 12px; margin-top: 20px; }
        button { font-family: 'Inter', sans-serif; cursor: pointer; }
        button.btn-primary { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: 500; flex: 1; transition: var(--transition); }
        button.btn-primary:hover { filter: brightness(110%); transform: translateY(-1px); }
        button.btn-cancel { background-color: #9ca3af; color: white; border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: 500; display: none; }
        
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background-color: #f8fafc; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; color: var(--text-primary); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }

        /* Badges e Botões de Ação */
        .badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; color: white; display: inline-block; text-align: center; min-width: 80px; }
        .bg-pendente { background-color: var(--warning); } .bg-andamento { background-color: var(--accent); } .bg-concluido { background-color: var(--success); }
        .bg-estacionado { background-color: var(--estacionado); } .bg-saiu { background-color: #94a3b8; } .bg-visitante-ativo { background-color: var(--recepcao); }
        .bg-interno { background-color: var(--primary); } .bg-externo { background-color: var(--evento); }
        .bg-baixa { background-color: var(--success); } .bg-media { background-color: var(--warning); } .bg-alta { background-color: #f97316; } .bg-critica { background-color: var(--ocorrencia); }
        
        .time-badge { background: #f1f5f9; color: var(--text-secondary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; border: 1px solid #e2e8f0; }
        .action-btn { border: none; width: 32px; height: 32px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; margin-right: 4px; color: white; font-size: 0.85rem; transition: var(--transition); }
        .action-btn:hover { transform: scale(1.1); }
        .btn-check { background-color: var(--success); }
        .btn-delete { background-color: var(--danger); }
        .btn-edit { background-color: var(--warning); }
        .btn-print { background-color: var(--info); }
        .btn-baixa { background-color: var(--danger); }

        /* Filtros e Responsividade */
        .filter-container { background-color: #f8fafc; padding: 16px; border-radius: var(--radius-md); border: 1px solid #e5e7eb; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; margin-bottom: 20px; }
        .filter-group { flex: 1; min-width: 160px; display: flex; flex-direction: column; gap: 4px;}
        .btn-excel { background-color: var(--excel); color: white; border: none; padding: 10px 16px; border-radius: var(--radius-md); font-weight: 600; display: flex; align-items: center; gap: 8px; height: 42px; transition: var(--transition); }
        .btn-excel:hover { background-color: #15803d; }
        .hidden-tab { display: none !important; }
        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); font-style: italic; }

        body.sidebar-collapsed .app-sidebar { width: var(--sidebar-collapsed-width); }
        body.sidebar-collapsed .sidebar-header span, body.sidebar-collapsed .nav-item span, body.sidebar-collapsed .sidebar-header i, body.sidebar-collapsed .sidebar-footer span, body.sidebar-collapsed .sidebar-footer .user-profile div { display: none; }
        body.sidebar-collapsed .sidebar-header { justify-content: center; padding: 0; }
        body.sidebar-collapsed .sidebar-header i.logo-icon { display: block; margin: 0; font-size: 1.5rem; }
        body.sidebar-collapsed .nav-item { justify-content: center; padding: 16px 0; }
        body.sidebar-collapsed .nav-item i { margin: 0; font-size: 1.3rem; }
        body.sidebar-collapsed .sidebar-footer { padding: 10px; display: flex; justify-content: center; }

        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 45; backdrop-filter: blur(2px); }
        @media (max-width: 768px) {
            .app-sidebar { position: fixed; left: -100%; height: 100%; width: 280px; box-shadow: var(--shadow-md); }
            .app-sidebar.mobile-open { left: 0; }
            .mobile-overlay.show { display: block; }
            .header-left .toggle-sidebar-btn { display: block; }
            .dashboard-panel { grid-template-columns: 1fr; }
            .filter-container { flex-direction: column; align-items: stretch; }
            .metric-card, .card { padding: 16px; }
        }
        .tipo-selector { display: flex; gap: 16px; margin-bottom: 20px; background: #f8fafc; padding: 12px; border-radius: var(--radius-md); border: 1px solid #e5e7eb; }
        .radio-label { display: flex; align-items: center; gap: 8px; font-weight: 500; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobileSidebar()"></div>
    
    <div id="login-overlay" class="login-wrapper">
        <div class="login-card">
            <div class="login-header">
                <div class="logo-circle"><i class="fas fa-building"></i></div>
                <h2>Bem-vindo(a)</h2>
                <p>Identifique-se para acessar o sistema.</p>
            </div>
            <div class="login-body">
                <div class="input-group">
                    <label for="login-user">Usuário</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="login-user" class="login-input" placeholder="Digite seu usuário" onkeyup="checkEnter(event)" autocomplete="username" autocapitalize="none" autocorrect="off">
                    </div>
                </div>
                <div class="input-group">
                    <label for="login-pass">Senha</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="login-pass" class="login-input" placeholder="Digite sua senha" onkeyup="checkEnter(event)" autocomplete="current-password" autocapitalize="none" autocorrect="off">
                        <button type="button" class="toggle-pass" onclick="togglePassword()" tabindex="-1">
                            <i class="far fa-eye" id="eye-icon"></i>
                        </button>
                    </div>
                </div>
                <div id="login-error" class="error-box">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Usuário ou senha incorretos.</span>
                </div>
                <button onclick="fazerLogin()" class="btn-login">
                    Entrar <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <div class="login-footer">&copy; 2026 COGESPA - Divisão de Zeladoria.</div>
        </div>
    </div>

    <div id="app-content" style="display:none; width:100%; height:100%;">
        <aside class="app-sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-building logo-icon"></i>
                <span>COGESPA - DZEL</span>
            </div>
            <nav class="sidebar-nav">
                <button id="tab-demandas" class="nav-item active" onclick="switchTab('demandas'); closeMobileSidebar()">
                    <i class="fas fa-clipboard-list"></i> <span>Demandas</span>
                </button>
                <button id="tab-visitantes" class="nav-item" onclick="switchTab('visitantes'); closeMobileSidebar()">
                    <i class="fas fa-users"></i> <span>Recepção</span>
                </button>
                <button id="tab-veiculos" class="nav-item" onclick="switchTab('veiculos'); closeMobileSidebar()">
                    <i class="fas fa-car"></i> <span>Garagem</span>
                </button>
                <button id="tab-eventos" class="nav-item" onclick="switchTab('eventos'); closeMobileSidebar()">
                    <i class="fas fa-calendar-alt"></i> <span>Eventos</span>
                </button>
                <button id="tab-ocorrencias" class="nav-item" onclick="switchTab('ocorrencias'); closeMobileSidebar()">
                    <i class="fas fa-triangle-exclamation"></i> <span>Ocorrências</span>
                </button>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <div>
                        <div id="user-display" style="font-size:0.9rem; font-weight:600;">Usuário</div>
                        <a href="#" onclick="logout()" style="color:var(--text-sidebar); font-size:0.75rem; text-decoration:none;">Sair do Sistema</a>
                    </div>
                </div>
            </div>
        </aside>

        <div class="app-main">
            <header class="app-header">
                <div class="header-left">
                    <button class="toggle-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <div class="page-title">DIVISÃO DE ZELADORIA</div>
                </div>
                <div class="header-right">
                    <span id="date-display"><i class="far fa-clock"></i> ...</span>
                </div>
            </header>

            <div class="content-area">
                <main class="container-limit">
                    <section id="demandas" class="section active">
                        <div class="dashboard-panel">
                            <div class="metric-card card-total"><div class="metric-info"><h3>Total</h3><p id="dash-demanda-total">...</p></div><i class="fas fa-folder-open metric-icon"></i></div>
                            <div class="metric-card card-pendente"><div class="metric-info"><h3>Pendentes</h3><p id="dash-demanda-pendente">...</p></div><i class="fas fa-clock metric-icon"></i></div>
                            <div class="metric-card card-andamento"><div class="metric-info"><h3>Em Andamento</h3><p id="dash-demanda-andamento">...</p></div><i class="fas fa-tools metric-icon"></i></div>
                            <div class="metric-card card-concluido"><div class="metric-info"><h3>Concluídas</h3><p id="dash-demanda-concluido">...</p></div><i class="fas fa-check-circle metric-icon"></i></div>
                        </div>
                        <div class="card">
                            <h2 id="titulo-form-demanda"><i class="fas fa-plus-circle" style="color:var(--primary)"></i> Nova Solicitação</h2>
                            <form id="form-demanda">
                                <input type="hidden" id="demanda-id-edit" value="">
                                <div class="form-grid">
                                    <div><label>Nº da O.S.</label><input type="text" id="demanda-numero-os" placeholder="Ex: 01"></div>
                                    <div><label>Descrição do Serviço</label><input type="text" id="demanda-titulo" required></div>
                                    <div><label>Local / Setor</label><input type="text" id="demanda-setor" required></div>
                                    <div><label>Solicitante</label><input type="text" id="demanda-solicitante" required></div>
                                    <div><label>Prioridade</label><select id="demanda-prioridade"><option value="Baixa">Baixa</option><option value="Média">Média</option><option value="Alta">Alta</option></select></div>
                                    <div><label>Data/Hora Solicitação</label><input type="datetime-local" id="demanda-data" required></div>
                                    
                                    <div style="grid-column: 1 / -1;"><label>Descrição Detalhada da Execução (Opcional)</label><textarea id="demanda-execucao" rows="2" placeholder="Preencha pelo celular/PC após realizar o serviço..."></textarea></div>
                                    <div style="grid-column: 1 / -1;"><label>Materiais / Peças Utilizadas (Opcional)</label><textarea id="demanda-materiais" rows="2" placeholder="Descreva os materiais utilizados..."></textarea></div>

                                    <div id="div-status-demanda" style="display:none"><label>Status</label><select id="demanda-status-edit"><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div>
                                </div>
                                <div class="btn-container">
                                    <button type="submit" class="btn-primary" id="btn-submit-demanda">Registrar Demanda</button>
                                    <button type="button" class="btn-cancel" id="btn-cancel-demanda" onclick="cancelarEdicaoDemanda()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                        <div class="card">
                            <div class="filter-container">
                                <div class="filter-group"><label>Mês Ref:</label><input type="month" id="filtro-mes-demanda" onchange="window.renderizarApenasDemandas()"></div>
                                <div class="filter-group"><label>Buscar:</label><input type="text" id="filtro-texto-demanda" onkeyup="window.renderizarApenasDemandas()" placeholder="Ex: Lâmpada..."></div>
                                <div class="filter-group"><label>Status:</label><select id="filtro-status-demanda" onchange="window.renderizarApenasDemandas()"><option value="">Todos</option><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div>
                                <button onclick="window.exportarParaExcel('demandas')" class="btn-excel"><i class="fas fa-file-excel"></i> Exportar</button>
                            </div>
                            <div class="table-container">
                                <table id="tabela-demandas">
                                    <thead><tr><th>Data</th><th>Prioridade</th><th>Serviço</th><th>Status</th><th>Tempo</th><th>Ações</th></tr></thead>
                                    <tbody><tr><td colspan="6" class="loading">Carregando dados...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="visitantes" class="section">
                        <div class="dashboard-panel">
                            <div class="metric-card card-recepcao"><div class="metric-info"><h3>Visitantes Ativos</h3><p id="dash-visitantes-ativos">...</p></div><i class="fas fa-users metric-icon"></i></div>
                            <div class="metric-card card-total"><div class="metric-info"><h3>Total no Período</h3><p id="dash-visitantes-total">...</p></div><i class="fas fa-list metric-icon"></i></div>
                        </div>
                        <div class="card">
                            <h2 id="titulo-form-visitante"><i class="fas fa-user-plus" style="color:var(--recepcao)"></i> Cadastrar Visitante</h2>
                            <form id="form-visitante">
                                <input type="hidden" id="visitante-id-edit" value="">
                                <div class="form-grid">
                                    <div><label>Nome Completo</label><input type="text" id="vis-nome" required placeholder="NOME DO VISITANTE"></div>
                                    <div><label>Empresa</label><input type="text" id="vis-empresa" placeholder="EMPRESA / ÓRGÃO"></div>
                                    <div><label>Responsável (Quem visita?)</label><input type="text" id="vis-responsavel" required placeholder="SETOR / NOME"></div>
                                    <div><label>Motivo da Visita</label><input type="text" id="vis-finalidade" required placeholder="REUNIÃO, ENTREGA, ETC."></div>
                                    <div><label>Entrada</label><input type="datetime-local" id="vis-entrada" required></div>
                                    <div style="display:none" id="div-status-vis"><label>Status</label><select id="vis-status-edit"><option value="Ativo">Na Empresa</option><option value="Saiu">Saiu</option></select></div>
                                </div>
                                <div class="btn-container">
                                    <button type="submit" class="btn-primary" id="btn-submit-vis">Registrar Entrada</button>
                                    <button type="button" class="btn-cancel" id="btn-cancel-vis" onclick="cancelarEdicaoVisitante()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                        <div class="card">
                            <div class="filter-container">
                                <div class="filter-group"><label>Mês:</label><input type="month" id="filtro-mes-vis" onchange="window.renderizarApenasVisitantes()"></div>
                                <div class="filter-group"><label>Buscar:</label><input type="text" id="filtro-busca-vis" onkeyup="window.renderizarApenasVisitantes()" placeholder="Nome, Empresa..."></div>
                                <button onclick="window.exportarParaExcel('visitantes')" class="btn-excel"><i class="fas fa-file-excel"></i> Exportar</button>
                            </div>
                            <div class="table-container">
                                <table id="tabela-visitantes">
                                    <thead><tr><th>Status</th><th>Nome</th><th>Empresa</th><th>Visitando / Motivo</th><th>Entrada/Saída</th><th>Ação</th></tr></thead>
                                    <tbody><tr><td colspan="6" class="loading">Carregando dados...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="veiculos" class="section">
                        <div class="dashboard-panel">
                            <div class="metric-card card-estacionado"><div class="metric-info"><h3>Estacionados</h3><p id="dash-frota-estacionados">...</p></div><i class="fas fa-parking metric-icon"></i></div>
                            <div class="metric-card card-total"><div class="metric-info"><h3>Acessos</h3><p id="dash-frota-total">...</p></div><i class="fas fa-car metric-icon"></i></div>
                            <div class="metric-card card-servidor"><div class="metric-info"><h3>Servidores</h3><p id="dash-servidor-count">...</p></div><i class="fas fa-id-badge metric-icon"></i></div>
                            <div class="metric-card card-visitante"><div class="metric-info"><h3>Visitantes</h3><p id="dash-visitante-count">...</p></div><i class="fas fa-user-tag metric-icon"></i></div>
                        </div>
                        <div class="card">
                            <h2 id="titulo-form-veiculo"><i class="fas fa-parking" style="color:var(--estacionado)"></i> Registrar Entrada</h2>
                            <form id="form-veiculo">
                                <input type="hidden" id="veiculo-id-edit" value="">
                                <div class="tipo-selector">
                                    <label class="radio-label"><input type="radio" name="tipoFluxo" id="radio-servidor" value="servidor" checked onclick="atualizarLabels()"> <span style="color:var(--servidor)">Servidor</span></label>
                                    <label class="radio-label"><input type="radio" name="tipoFluxo" id="radio-visitante" value="visitante" onclick="atualizarLabels()"> <span style="color:var(--visitante)">Visitante</span></label>
                                </div>
                                <div class="form-grid">
                                    <div><label>Veículo (Modelo - Placa)</label><input type="text" id="veiculo-carro" required></div>
                                    <div><label>Condutor</label><input type="text" id="veiculo-motorista" required></div>
                                    <div><label id="lbl-veiculo-setor">Setor</label><input type="text" id="veiculo-setor" required></div>
                                    <div><label>Contato</label><input type="text" id="veiculo-contato"></div>
                                    <div><label>Destino/Obs</label><input type="text" id="veiculo-destino"></div>
                                    <div><label>KM Entrada</label><input type="number" id="veiculo-km-saida" placeholder="0"></div>
                                    <div><label>Entrada</label><input type="datetime-local" id="veiculo-hora-saida" required></div>
                                    <div id="container-status-veiculo" style="display:none"><label>Status</label><select id="veiculo-status-edit"><option value="Aberto">Estacionado</option><option value="Fechado">Finalizado</option></select></div>
                                </div>
                                <div class="btn-container">
                                    <button type="submit" class="btn-primary" id="btn-submit-veiculo">Registrar Entrada</button>
                                    <button type="button" class="btn-cancel" id="btn-cancel-veiculo" onclick="cancelarEdicaoVeiculo()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                        <div class="card">
                            <div class="filter-container">
                                <div class="filter-group"><label>Mês:</label><input type="month" id="filtro-mes-frota" onchange="window.renderizarApenasFrota()"></div>
                                <div class="filter-group"><label>Buscar:</label><input type="text" id="filtro-busca-frota" onkeyup="window.renderizarApenasFrota()" placeholder="Nome, Placa..."></div>
                                <button onclick="window.exportarParaExcel('veiculos')" class="btn-excel"><i class="fas fa-file-excel"></i> Exportar</button>
                            </div>
                            <div class="table-container">
                                <table id="tabela-veiculos">
                                    <thead><tr><th>Status</th><th>Tipo</th><th>Condutor</th><th>Veículo</th><th>Setor</th><th>Entrada/Saída</th><th>Ações</th></tr></thead>
                                    <tbody><tr><td colspan="6" class="loading">Carregando dados...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="eventos" class="section">
                        <div class="dashboard-panel">
                            <div class="metric-card card-evt-total"><div class="metric-info"><h3>Total</h3><p id="dash-eventos-qtd">...</p></div><i class="fas fa-calendar metric-icon"></i></div>
                            <div class="metric-card card-evt-interno"><div class="metric-info"><h3>Internos</h3><p id="dash-eventos-interno">...</p></div><i class="fas fa-building metric-icon"></i></div>
                            <div class="metric-card card-evt-externo"><div class="metric-info"><h3>Externos</h3><p id="dash-eventos-externo">...</p></div><i class="fas fa-globe metric-icon"></i></div>
                            <div class="metric-card card-evt-publico"><div class="metric-info"><h3>Público</h3><p id="dash-eventos-publico">...</p></div><i class="fas fa-users metric-icon"></i></div>
                        </div>
                        <div class="card">
                            <h2 id="titulo-form-evento"><i class="fas fa-calendar-plus" style="color:var(--evento)"></i> Registrar Evento</h2>
                            <form id="form-evento">
                                <input type="hidden" id="evento-id-edit" value="">
                                <div class="tipo-selector">
                                    <label class="radio-label"><input type="radio" name="tipoEvento" value="Interno" checked> <span style="color:var(--primary)">Interno</span></label>
                                    <label class="radio-label"><input type="radio" name="tipoEvento" value="Externo"> <span style="color:var(--evento)">Externo</span></label>
                                </div>
                                <div class="form-grid">
                                    <div><label>Nome do Evento</label><input type="text" id="evento-nome" required></div>
                                    <div><label>Organizador</label><input type="text" id="evento-organizador" required></div>
                                    <div><label>Data</label><input type="date" id="evento-data" required></div>
                                    <div><label>Público Est.</label><input type="number" id="evento-publico" required></div>
                                    <div><label>Local</label><input type="text" id="evento-local" required></div>
                                    <div class="checkbox-wrapper" style="align-self: flex-end; margin-bottom: 5px;">
                                        <input type="checkbox" id="evento-coffee" style="width:auto">
                                        <label for="evento-coffee" style="color:var(--coffee); margin:0"><i class="fas fa-coffee"></i> Coffee Break?</label>
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label>Observações</label>
                                        <textarea id="evento-obs" rows="2"></textarea>
                                    </div>
                                </div>
                                <div class="btn-container">
                                    <button type="submit" class="btn-primary" id="btn-submit-evento">Salvar Evento</button>
                                    <button type="button" class="btn-cancel" id="btn-cancel-evento" onclick="cancelarEdicaoEvento()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                        <div class="card">
                            <div class="filter-container">
                                <div class="filter-group"><label>Mês:</label><input type="month" id="filtro-mes-evento" onchange="window.renderizarApenasEventos()"></div>
                                <div class="filter-group"><label>Buscar:</label><input type="text" id="filtro-busca-evento" onkeyup="window.renderizarApenasEventos()" placeholder="Nome..."></div>
                                <button onclick="window.exportarParaExcel('eventos')" class="btn-excel"><i class="fas fa-file-excel"></i> Exportar</button>
                            </div>
                            <div class="table-container">
                                <table id="tabela-eventos">
                                    <thead><tr><th>Data</th><th>Tipo</th><th>Evento / Local / Obs</th><th>Organizador</th><th>Público</th><th>Ações</th></tr></thead>
                                    <tbody><tr><td colspan="6" class="loading">Carregando dados...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="ocorrencias" class="section">
                        <div class="dashboard-panel">
                            <div class="metric-card card-total"><div class="metric-info"><h3>Total</h3><p id="dash-oco-total">...</p></div><i class="fas fa-clipboard-list metric-icon"></i></div>
                            <div class="metric-card card-ocorrencia"><div class="metric-info"><h3>Abertas</h3><p id="dash-oco-abertas">...</p></div><i class="fas fa-exclamation-circle metric-icon"></i></div>
                            <div class="metric-card card-pendente"><div class="metric-info"><h3>Em Tratativa</h3><p id="dash-oco-tratativa">...</p></div><i class="fas fa-tools metric-icon"></i></div>
                            <div class="metric-card card-concluido"><div class="metric-info"><h3>Encerradas</h3><p id="dash-oco-encerradas">...</p></div><i class="fas fa-check-circle metric-icon"></i></div>
                        </div>
                        <div class="card">
                            <h2 id="titulo-form-ocorrencia"><i class="fas fa-exclamation-triangle" style="color:var(--ocorrencia)"></i> Registrar Ocorrência</h2>
                            <form id="form-ocorrencia">
                                <input type="hidden" id="ocorrencia-id-edit" value="">
                                <div class="form-grid">
                                    <div><label>Unidade / Prédio</label><input type="text" id="oco-unidade" required></div>
                                    <div><label>Local / Setor</label><input type="text" id="oco-local" required></div>
                                    <div><label>Categoria</label>
                                        <select id="oco-categoria">
                                            <option value="Segurança">Segurança</option><option value="Manutenção">Manutenção</option>
                                            <option value="Limpeza">Limpeza</option><option value="Ar Condicionado">Ar Condicionado</option>
                                            <option value="Recepção">Recepção</option><option value="Copa Gabinete">Copa Gabinete</option>
                                            <option value="Purificador de Água">Purificador de Água</option><option value="Bombeiro">Bombeiro</option>
                                            <option value="Dedetização">Dedetização</option>
                                        </select>
                                    </div>
                                    <div><label>Gravidade</label><select id="oco-gravidade"><option value="Baixa">Baixa</option><option value="Média">Média</option><option value="Alta">Alta</option><option value="Crítica">Crítica</option></select></div>
                                    <div><label>Data/Hora</label><input type="datetime-local" id="oco-data" required></div>
                                    <div><label>Responsável</label><input type="text" id="oco-responsavel" required></div>
                                    <div style="grid-column: 1/-1"><label>Descrição Detalhada</label><textarea id="oco-descricao" rows="3" required></textarea></div>
                                    <div id="div-status-oco" style="display:none"><label>Status Atual</label><select id="oco-status-edit"><option value="Aberta">Aberta</option><option value="Em Tratativa">Em Tratativa</option><option value="Encerrada">Encerrada</option></select></div>
                                </div>
                                <div class="btn-container">
                                    <button type="submit" class="btn-primary" id="btn-submit-oco" style="background-color:var(--ocorrencia)">Registrar Ocorrência</button>
                                    <button type="button" class="btn-cancel" id="btn-cancel-oco" onclick="cancelarEdicaoOcorrencia()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                        <div class="card">
                            <div class="filter-container">
                                <div class="filter-group"><label>Mês:</label><input type="month" id="filtro-mes-oco" onchange="window.renderizarApenasOcorrencias()"></div>
                                <div class="filter-group"><label>Buscar:</label><input type="text" id="filtro-busca-oco" onkeyup="window.renderizarApenasOcorrencias()" placeholder="Local, Desc..."></div>
                                <div class="filter-group"><label>Status:</label><select id="filtro-status-oco" onchange="window.renderizarApenasOcorrencias()"><option value="">Todos</option><option value="Aberta">Aberta</option><option value="Em Tratativa">Em Tratativa</option><option value="Encerrada">Encerrada</option></select></div>
                                <button onclick="window.exportarParaExcel('ocorrencias')" class="btn-excel"><i class="fas fa-file-excel"></i> Exportar</button>
                            </div>
                            <div class="table-container">
                                <table id="tabela-ocorrencias">
                                    <thead><tr><th>Data/Hora</th><th>Gravidade</th><th>Categoria / Local</th><th>Descrição</th><th>Status</th><th>Tempo</th><th>Ações</th></tr></thead>
                                    <tbody><tr><td colspan="7" class="loading">Carregando ocorrências...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, update, remove, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // CONFIGURACAO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAEU-SuZxNkN6R6QRhL2Iky4vyffIOb3HY",
            authDomain: "zeladoriaapp-9aaed.firebaseapp.com",
            databaseURL: "https://zeladoriaapp-9aaed-default-rtdb.firebaseio.com",
            projectId: "zeladoriaapp-9aaed",
            storageBucket: "zeladoriaapp-9aaed.firebasestorage.app",
            messagingSenderId: "982940200696",
            appId: "1:982940200696:web:103df43dbf2a62ef8b150d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // MÁQUINA DE ESTADOS
        const FLUXO_STATUS = { 'PENDENTE': 'Em Andamento', 'EM ANDAMENTO': 'Concluído' };

        // VARIAVEIS GLOBAIS
        let demandas = [];
        let frota = [];
        let visitantes = [];
        let eventos = [];
        let ocorrencias = [];

        // --- FORÇAR MAIÚSCULAS NOS CAMPOS DE TEXTO ---
        document.addEventListener('input', function(e) {
            if (e.target.matches('input:not(.login-input)[type="text"], textarea:not(.login-input)')) {
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = e.target.value.toUpperCase();
                e.target.setSelectionRange(start, end);
            }
        });

        // --- UI CONTROL ---
        window.toggleSidebar = function() {
            if (window.innerWidth <= 768) { 
                toggleMobileSidebar(); 
            } else { 
                document.body.classList.toggle('sidebar-collapsed'); 
            }
        };

        window.toggleMobileSidebar = function() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
            document.getElementById('mobile-overlay').classList.toggle('show');
        };

        window.closeMobileSidebar = function() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
                document.getElementById('mobile-overlay').classList.remove('show');
            }
        };

        // --- LÓGICA VISUAL DA CAPA DE LOGIN ---
        window.togglePassword = function() {
            const passInput = document.getElementById('login-pass');
            const eyeIcon = document.getElementById('eye-icon');
            if (passInput.type === "password") {
                passInput.type = "text";
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passInput.type = "password";
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        // --- LÓGICA DE LOGIN ---
        const CREDENCIAIS = {
            'admin': { passMask: 'YWRtaW4yNDUx', role: 'admin', nome: 'Administrador' },
            'zeladoria': { passMask: 'emVsYWRvcmlh', role: 'zeladoria', nome: 'Zeladoria' },
            'portaria': { passMask: 'cG9ydGFyaWE=', role: 'portaria', nome: 'Portaria' },
            'recepcao': { passMask: 'cmVjZXBjYW8=', role: 'recepcao', nome: 'Recepção' }
        };
        let currentUserRole = null;

        const usuarioSalvo = localStorage.getItem('zeladoria_user');
        if (usuarioSalvo) {
            const user = JSON.parse(usuarioSalvo);
            setTimeout(() => { currentUserRole = user.role; iniciarSistema(user); }, 100);
        }

        window.checkEnter = function(e) { 
            if(e.key === 'Enter') window.fazerLogin(); 
        }

        window.fazerLogin = function() {
            const userKey = document.getElementById('login-user').value.trim().toLowerCase();
            const passOriginal = document.getElementById('login-pass').value.trim().toLowerCase(); 
            const passDigitadaMask = btoa(passOriginal);

            if (CREDENCIAIS[userKey] && CREDENCIAIS[userKey].passMask === passDigitadaMask) {
                currentUserRole = CREDENCIAIS[userKey].role;
                localStorage.setItem('zeladoria_user', JSON.stringify(CREDENCIAIS[userKey]));
                iniciarSistema(CREDENCIAIS[userKey]);
            } else {
                document.getElementById('login-error').style.display = 'flex';
            }
        }

        function iniciarSistema(userData) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'flex';
            document.getElementById('user-display').innerText = `Olá, ${userData.nome}`;
            
            const tDemandas = document.getElementById('tab-demandas');
            const tVisitantes = document.getElementById('tab-visitantes');
            const tVeiculos = document.getElementById('tab-veiculos');
            const tEventos = document.getElementById('tab-eventos');
            const tOcorrencias = document.getElementById('tab-ocorrencias');

            [tDemandas, tVisitantes, tVeiculos, tEventos, tOcorrencias].forEach(t => {
                t.classList.remove('hidden-tab');
                t.style.display = ''; 
            });

            window.renderizarApenasDemandas();
            window.renderizarApenasVisitantes();
            window.renderizarApenasFrota();
            window.renderizarApenasEventos();
            window.renderizarApenasOcorrencias();

            if (userData.role !== 'admin') {
                tOcorrencias.classList.add('hidden-tab');
            }

            if (userData.role === 'zeladoria') { 
                tVisitantes.classList.add('hidden-tab'); 
                tVeiculos.classList.add('hidden-tab'); 
                window.switchTab('demandas'); 
            } else if (userData.role === 'portaria') { 
                tDemandas.classList.add('hidden-tab'); 
                tEventos.classList.add('hidden-tab');
                tVisitantes.classList.add('hidden-tab');
                window.switchTab('veiculos'); 
            } else if (userData.role === 'recepcao') { 
                tDemandas.classList.add('hidden-tab'); 
                tVeiculos.classList.add('hidden-tab'); 
                tEventos.classList.add('hidden-tab'); 
                window.switchTab('visitantes'); 
            } else { 
                if(!document.querySelector('.section.active')) window.switchTab('demandas'); 
            }
        }

        window.logout = function() { localStorage.removeItem('zeladoria_user'); location.reload(); }

        function getLocalISO() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0,16);
        }

        document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR', {weekday: 'short', day:'numeric', month:'long'});
        document.getElementById('demanda-data').value = getLocalISO();
        document.getElementById('evento-data').valueAsDate = new Date();
        document.getElementById('vis-entrada').value = getLocalISO();
        document.getElementById('veiculo-hora-saida').value = getLocalISO();
        document.getElementById('oco-data').value = getLocalISO();

        window.switchTab = function(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const btn = document.getElementById('tab-' + tabId); if(btn) btn.classList.add('active');
        }

        function calcularTempoDecorrido(dataInicio, dataFim = new Date()) {
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            const diffMs = fim - inicio;
            if (diffMs < 0) return "0 min";
            const totalMinutos = Math.floor(diffMs / 60000);
            const dias = Math.floor(totalMinutos / 1440);
            const horas = Math.floor((totalMinutos % 1440) / 60);
            const minutos = totalMinutos % 60;
            if (dias > 0) return `${dias}d ${horas}h ${minutos}m`;
            if (horas > 0) return `${horas}h ${minutos}m`;
            return `${minutos} min`;
        }

        function formatarData(dataISO) { 
            if(!dataISO) return ''; 
            if(dataISO.includes('T')) { const d = new Date(dataISO); return d.toLocaleDateString('pt-BR'); }
            const [ano, mes, dia] = dataISO.split('-'); return `${dia}/${mes}/${ano}`; 
        }

        function formatarDataHora(dataISO) { 
            if(!dataISO) return ''; 
            return new Date(dataISO).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); 
        }

        // --- 1. DEMANDAS ---
        const formDemanda = document.getElementById('form-demanda');
        formDemanda.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('demanda-id-edit').value;
            const id = idEdicao || Date.now(); 
            
            const novaDemanda = {
                id: id,
                numeroOS: document.getElementById('demanda-numero-os').value.trim(), 
                titulo: document.getElementById('demanda-titulo').value.toUpperCase(),
                setor: document.getElementById('demanda-setor').value.toUpperCase(),
                solicitante: document.getElementById('demanda-solicitante').value.toUpperCase(),
                prioridade: document.getElementById('demanda-prioridade').value,
                data: document.getElementById('demanda-data').value,
                execucao: document.getElementById('demanda-execucao').value.toUpperCase(),
                materiais: document.getElementById('demanda-materiais').value.toUpperCase(),
                status: idEdicao ? document.getElementById('demanda-status-edit').value : 'Pendente',
                dataFim: null 
            };
            
            if(idEdicao) {
                const itemAntigo = demandas.find(d => String(d.id) === String(id));
                if(novaDemanda.status === 'Concluído' && (!itemAntigo || itemAntigo.status !== 'Concluído')) {
                    novaDemanda.dataFim = new Date().toISOString();
                } else if (itemAntigo && itemAntigo.dataFim) {
                    novaDemanda.dataFim = itemAntigo.dataFim;
                }
            }
            set(ref(db, 'demandas/' + id), novaDemanda)
                .then(() => { cancelarEdicaoDemanda(); })
                .catch((error) => alert("Erro ao salvar: " + error));
        });

        onValue(ref(db, 'demandas'), (snapshot) => {
            const data = snapshot.val();
            demandas = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
            demandas.sort((a,b) => b.id - a.id);
            window.renderizarApenasDemandas();
        });

        window.editarDemanda = function(id) {
            const d = demandas.find(item => String(item.id) === String(id)); if (!d) return;
            document.getElementById('demanda-id-edit').value = d.id;
            document.getElementById('demanda-numero-os').value = d.numeroOS || ''; 
            document.getElementById('demanda-titulo').value = d.titulo; 
            document.getElementById('demanda-setor').value = d.setor;
            document.getElementById('demanda-solicitante').value = d.solicitante; 
            document.getElementById('demanda-prioridade').value = d.prioridade;
            document.getElementById('demanda-data').value = d.data;
            document.getElementById('demanda-execucao').value = d.execucao || ''; 
            document.getElementById('demanda-materiais').value = d.materiais || ''; 
            document.getElementById('titulo-form-demanda').innerHTML = '<i class="fas fa-edit"></i> Editando Demanda';
            document.getElementById('btn-submit-demanda').innerText = "Salvar Alterações"; 
            document.getElementById('btn-cancel-demanda').style.display = "block";
            const divStatus = document.getElementById('div-status-demanda'); if(divStatus) divStatus.style.display = "block";
            const selectStatus = document.getElementById('demanda-status-edit'); if(selectStatus) selectStatus.value = d.status;
            document.getElementById('demandas').scrollIntoView({behavior: 'smooth'});
        }

        window.cancelarEdicaoDemanda = function() {
            document.getElementById('demanda-id-edit').value = ""; formDemanda.reset(); 
            document.getElementById('demanda-data').value = getLocalISO();
            document.getElementById('demanda-execucao').value = ""; 
            document.getElementById('demanda-materiais').value = ""; 
            document.getElementById('titulo-form-demanda').innerHTML = '<i class="fas fa-plus-circle"></i> Nova Solicitação';
            document.getElementById('btn-submit-demanda').innerText = "Registrar Demanda"; 
            document.getElementById('btn-cancel-demanda').style.display = "none"; 
            const divStatus = document.getElementById('div-status-demanda'); if(divStatus) divStatus.style.display = "none";
        }

        window.renderizarApenasDemandas = function() {
            const filtroMes = document.getElementById('filtro-mes-demanda').value; 
            const filtroStatus = document.getElementById('filtro-status-demanda').value;
            const filtroTexto = document.getElementById('filtro-texto-demanda').value.toLowerCase();
            const lista = demandas.filter(d => {
                const bateData = !filtroMes || d.data.startsWith(filtroMes);
                const bateStatus = !filtroStatus || d.status === filtroStatus;
                const textoGeral = (d.titulo + ' ' + d.setor + ' ' + d.solicitante + ' ' + (d.numeroOS || '')).toLowerCase();
                const bateTexto = !filtroTexto || textoGeral.includes(filtroTexto);
                return bateData && bateStatus && bateTexto;
            });
            document.getElementById('dash-demanda-total').innerText = lista.length;
            document.getElementById('dash-demanda-pendente').innerText = lista.filter(d => d.status === 'Pendente').length;
            document.getElementById('dash-demanda-andamento').innerText = lista.filter(d => d.status === 'Em Andamento').length;
            document.getElementById('dash-demanda-concluido').innerText = lista.filter(d => d.status === 'Concluído').length;

            const tbody = document.querySelector('#tabela-demandas tbody'); tbody.innerHTML = '';
            lista.forEach(d => {
                const tr = document.createElement('tr');
                let badgeClass = d.status === 'Pendente' ? 'bg-pendente' : (d.status === 'Em Andamento' ? 'bg-andamento' : 'bg-concluido');
                let tempoDisplay = d.status === 'Concluído' && d.dataFim ? `<span class="time-badge"><i class="fas fa-stopwatch"></i> ${calcularTempoDecorrido(d.data, d.dataFim)}</span>` : `<span class="time-badge"><i class="fas fa-hourglass-half"></i> ${calcularTempoDecorrido(d.data)}</span>`;
                const btnAvancar = d.status !== 'Concluído' ? `<button onclick="avancarStatus('${d.id}')" class="action-btn btn-check" title="Avançar"><i class="fas fa-arrow-right"></i></button>` : '';
                const dataFormatada = new Date(d.data).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                
                tr.innerHTML = `<td>${dataFormatada}</td><td><span class="badge" style="background:#94a3b8">${d.prioridade}</span></td><td><strong>${d.titulo}</strong><br><small style="color:var(--text-secondary)">${d.solicitante} - ${d.setor}</small></td><td><span class="badge ${badgeClass}">${d.status}</span></td><td>${tempoDisplay}</td><td style="min-width:160px">${btnAvancar}<button onclick="imprimirOS('${d.id}')" class="action-btn btn-print" title="Imprimir O.S."><i class="fas fa-print"></i></button><button onclick="editarDemanda('${d.id}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button><button onclick="deletarDemanda('${d.id}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        window.avancarStatus = async function(id) { 
            const btnAlvo = document.querySelector(`button[onclick*="${id}"]`);
            if(btnAlvo) { btnAlvo.disabled = true; btnAlvo.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
            const itemRef = ref(db, `demandas/${id}`);
            try {
                await runTransaction(itemRef, (postAtual) => {
                    if (postAtual === null) return;
                    const statusAtualLimpo = (postAtual.status || 'PENDENTE').toUpperCase().trim();
                    const proximoStatus = FLUXO_STATUS[statusAtualLimpo];
                    if (proximoStatus) {
                        postAtual.status = proximoStatus;
                        if (proximoStatus === 'Concluído') { postAtual.dataFim = new Date().toISOString(); }
                        return postAtual;
                    } else { return; }
                });
            } catch (error) { 
                console.error(error); alert("Erro ao atualizar."); 
            } finally { 
                if(btnAlvo) { btnAlvo.disabled = false; btnAlvo.innerHTML = '<i class="fas fa-arrow-right"></i>'; } 
            }
        };

        window.deletarDemanda = function(id) {
            if(confirm('Excluir?')) {
                remove(ref(db, 'demandas/' + id));
                if(document.getElementById('demanda-id-edit').value == id) cancelarEdicaoDemanda();
            }
        }

        // --- 2. VISITANTES --- 
        const formVis = document.getElementById('form-visitante');
        formVis.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('visitante-id-edit').value;
            const id = idEdicao || Date.now();
            const novoVisitante = {
                id: id,
                nome: document.getElementById('vis-nome').value.toUpperCase(),
                empresa: document.getElementById('vis-empresa').value.toUpperCase(),
                responsavel: document.getElementById('vis-responsavel').value.toUpperCase(),
                finalidade: document.getElementById('vis-finalidade').value.toUpperCase(),
                entrada: document.getElementById('vis-entrada').value,
                status: idEdicao ? document.getElementById('vis-status-edit').value : 'Ativo',
                saida: null 
            };
            if(idEdicao) {
                const ant = visitantes.find(v => String(v.id) === String(id));
                if (novoVisitante.status === 'Ativo') {
                    novoVisitante.saida = null;
                } else {
                    if (ant && ant.saida) { novoVisitante.saida = ant.saida; } 
                    else { novoVisitante.saida = new Date().toISOString(); }
                }
            }
            set(ref(db, 'visitantes/' + id), novoVisitante).then(() => cancelarEdicaoVisitante());
        });

        onValue(ref(db, 'visitantes'), (snapshot) => {
            const data = snapshot.val();
            visitantes = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
            visitantes.sort((a,b) => b.id - a.id);
            window.renderizarApenasVisitantes();
        });

        window.editarVisitante = function(id) {
            const v = visitantes.find(i => String(i.id) === String(id)); if(!v) return;
            document.getElementById('visitante-id-edit').value = v.id;
            document.getElementById('vis-nome').value = v.nome; 
            document.getElementById('vis-empresa').value = v.empresa; 
            document.getElementById('vis-responsavel').value = v.responsavel; 
            document.getElementById('vis-finalidade').value = v.finalidade; 
            document.getElementById('vis-entrada').value = v.entrada;
            document.getElementById('titulo-form-visitante').innerHTML = '<i class="fas fa-edit"></i> Editando Visitante'; 
            document.getElementById('btn-submit-vis').innerText = "Salvar Alterações"; 
            document.getElementById('btn-cancel-vis').style.display = "block";
            const divStatus = document.getElementById('div-status-vis'); if(divStatus) divStatus.style.display="block";
            const selStat = document.getElementById('vis-status-edit'); if(selStat) selStat.value = v.status;
            document.getElementById('visitantes').scrollIntoView({behavior:'smooth'});
        }
        
        window.deletarVisitante = function(id) { 
            if(confirm('Excluir?')) { 
                remove(ref(db, 'visitantes/' + id)); 
                if(document.getElementById('visitante-id-edit').value == id) cancelarEdicaoVisitante(); 
            } 
        }
        
        window.cancelarEdicaoVisitante = function() { 
            document.getElementById('visitante-id-edit').value = ""; 
            formVis.reset(); 
            document.getElementById('vis-entrada').value = getLocalISO(); 
            document.getElementById('titulo-form-visitante').innerHTML = '<i class="fas fa-user-plus"></i> Cadastrar Visitante'; 
            document.getElementById('btn-submit-vis').innerText = "Registrar Entrada"; 
            document.getElementById('btn-cancel-vis').style.display = "none"; 
            document.getElementById('div-status-vis').style.display="none"; 
        }

        window.renderizarApenasVisitantes = function() {
            const mes = document.getElementById('filtro-mes-vis').value; 
            const termo = document.getElementById('filtro-busca-vis').value.toLowerCase();
            const lista = visitantes.filter(v => { 
                const bateMes = !mes || v.entrada.startsWith(mes); 
                const bateTermo = !termo || v.nome.toLowerCase().includes(termo) || (v.empresa && v.empresa.toLowerCase().includes(termo)); 
                return bateMes && bateTermo; 
            });
            document.getElementById('dash-visitantes-ativos').innerText = lista.filter(v => v.status === 'Ativo').length; 
            document.getElementById('dash-visitantes-total').innerText = lista.length;
            const tbody = document.querySelector('#tabela-visitantes tbody'); tbody.innerHTML = '';
            lista.forEach(v => {
                const tr = document.createElement('tr');
                const badge = v.status === 'Ativo' ? '<span class="badge bg-visitante-ativo">NA EMPRESA</span>' : '<span class="badge bg-saiu">SAIU</span>';
                const dataEnt = new Date(v.entrada).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
                const dataSai = v.saida ? new Date(v.saida).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
                const btnBaixa = v.status === 'Ativo' ? `<button onclick="baixaVisitante('${v.id}')" class="action-btn btn-baixa" title="Registrar Saída"><i class="fas fa-sign-out-alt"></i></button>` : '<i class="fas fa-check" style="color:var(--success); margin-right:5px"></i>';
                let btnExcluir = ''; if (currentUserRole === 'admin') btnExcluir = `<button onclick="deletarVisitante('${v.id}')" class="action-btn btn-delete" title="Excluir"><i class="fas fa-trash"></i></button>`;
                tr.innerHTML = `<td>${badge}</td><td><strong>${v.nome}</strong></td><td>${v.empresa || '-'}</td><td>${v.responsavel}<br><small style="color:var(--text-secondary)">${v.finalidade}</small></td><td>Ent: ${dataEnt}<br>Sai: ${dataSai}</td><td style="min-width:140px">${btnBaixa}<button onclick="editarVisitante('${v.id}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button>${btnExcluir}</td>`;
                tbody.appendChild(tr);
            });
        }
        
        window.baixaVisitante = function(id) { 
            if(confirm('Confirmar saída do visitante?')) { 
                update(ref(db, 'visitantes/' + id), { status: 'Saiu', saida: new Date().toISOString() }); 
            } 
        }

        // --- 3. VEICULOS --- 
        window.atualizarLabels = function() {
            const tipo = document.querySelector('input[name="tipoFluxo"]:checked').value; 
            const btn = document.getElementById('btn-submit-veiculo');
            if (!document.getElementById('veiculo-id-edit').value) btn.innerText = "Registrar Entrada";
            const lblSetor = document.getElementById('lbl-veiculo-setor');
            if (tipo === 'servidor') { 
                btn.style.backgroundColor = "var(--servidor)"; 
                document.getElementById('veiculo-setor').placeholder = "Setor de Origem"; 
                if(lblSetor) lblSetor.innerText = "Setor Origem"; 
            } else { 
                btn.style.backgroundColor = "var(--visitante)"; 
                document.getElementById('veiculo-setor').placeholder = "Empresa / Setor Visitado"; 
                if(lblSetor) lblSetor.innerText = "Setor/Empresa"; 
            }
        }
        
        const formVeiculo = document.getElementById('form-veiculo');
        formVeiculo.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('veiculo-id-edit').value;
            const id = idEdicao || Date.now();
            const tipo = document.querySelector('input[name="tipoFluxo"]:checked').value;
            const novoVeiculo = { id: id, tipo: tipo, carro: document.getElementById('veiculo-carro').value.toUpperCase(), motorista: document.getElementById('veiculo-motorista').value.toUpperCase(), setor: document.getElementById('veiculo-setor').value.toUpperCase(), contato: document.getElementById('veiculo-contato').value.toUpperCase(), destino: document.getElementById('veiculo-destino').value.toUpperCase(), kmInicial: document.getElementById('veiculo-km-saida').value || 0, horaInicial: document.getElementById('veiculo-hora-saida').value, status: idEdicao ? document.getElementById('veiculo-status-edit').value : 'Aberto', kmFinal: null, horaFinal: null };
            if(idEdicao) { 
                const ant = frota.find(f => String(f.id) === String(id)); 
                if (novoVeiculo.status === 'Aberto') { novoVeiculo.horaFinal = null; novoVeiculo.kmFinal = null; } 
                else if (ant && ant.horaFinal) { novoVeiculo.horaFinal = ant.horaFinal; novoVeiculo.kmFinal = ant.kmFinal; } 
            }
            set(ref(db, 'frota/' + id), novoVeiculo).then(() => { cancelarEdicaoVeiculo(); window.atualizarLabels(); });
        });
        
        onValue(ref(db, 'frota'), (snapshot) => {
            const data = snapshot.val();
            frota = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
            frota.sort((a,b) => b.id - a.id);
            window.renderizarApenasFrota();
        });
        
        window.editarVeiculo = function(id) {
            const f = frota.find(i => String(i.id) === String(id)); if (!f) return;
            document.getElementById('veiculo-id-edit').value = f.id; 
            document.getElementById('veiculo-carro').value = f.carro; 
            document.getElementById('veiculo-motorista').value = f.motorista; 
            document.getElementById('veiculo-setor').value = f.setor || ''; 
            document.getElementById('veiculo-contato').value = f.contato || ''; 
            document.getElementById('veiculo-destino').value = f.destino; 
            document.getElementById('veiculo-km-saida').value = f.kmInicial; 
            document.getElementById('veiculo-hora-saida').value = f.horaInicial;
            if (f.tipo === 'servidor') document.getElementById('radio-servidor').checked = true; else document.getElementById('radio-visitante').checked = true;
            document.getElementById('titulo-form-veiculo').innerHTML = '<i class="fas fa-edit"></i> Editando Veículo'; 
            const btn = document.getElementById('btn-submit-veiculo'); btn.innerText = "Salvar Alterações"; btn.style.backgroundColor = "var(--edit)";
            document.getElementById('btn-cancel-veiculo').style.display = "block"; 
            document.getElementById('container-status-veiculo').style.display = "block"; 
            document.getElementById('veiculo-status-edit').value = f.status;
            window.atualizarLabels(); document.getElementById('veiculos').scrollIntoView({behavior: 'smooth'});
        }
        
        window.deletarVeiculo = function(id) { 
            if(confirm('Tem certeza que deseja EXCLUIR este registro da garagem?')) { 
                remove(ref(db, 'frota/' + id)); 
                if(document.getElementById('veiculo-id-edit').value == id) cancelarEdicaoVeiculo(); 
            } 
        }
        
        window.cancelarEdicaoVeiculo = function() { 
            document.getElementById('veiculo-id-edit').value = ""; formVeiculo.reset(); 
            document.getElementById('veiculo-hora-saida').value = getLocalISO(); 
            document.getElementById('titulo-form-veiculo').innerHTML = '<i class="fas fa-parking"></i> Registrar Entrada'; 
            document.getElementById('btn-cancel-veiculo').style.display = "none"; 
            document.getElementById('container-status-veiculo').style.display = "none"; 
            document.getElementById('radio-servidor').checked = true; window.atualizarLabels(); 
        }
        
        window.renderizarApenasFrota = function() {
            const mes = document.getElementById('filtro-mes-frota').value; 
            const busca = document.getElementById('filtro-busca-frota').value.toLowerCase();
            const lista = frota.filter(f => { 
                const bData = !mes || f.horaInicial.startsWith(mes); 
                const bTexto = !busca || (f.motorista+f.carro+f.setor).toLowerCase().includes(busca); 
                return bData && bTexto; 
            });
            document.getElementById('dash-frota-total').innerText = lista.length; 
            document.getElementById('dash-frota-estacionados').innerText = lista.filter(f => f.status === 'Aberto').length; 
            document.getElementById('dash-servidor-count').innerText = lista.filter(f => f.tipo === 'servidor').length; 
            document.getElementById('dash-visitante-count').innerText = lista.filter(f => f.tipo === 'visitante').length;
            const tbody = document.querySelector('#tabela-veiculos tbody'); tbody.innerHTML = '';
            lista.forEach(f => {
                const tr = document.createElement('tr');
                const badge = f.status === 'Aberto' ? '<span class="badge bg-estacionado">ESTACIONADO</span>' : '<span class="badge bg-saiu">FINALIZADO</span>';
                const icon = f.tipo === 'servidor' ? '<i class="fas fa-id-badge" style="color:var(--servidor)"></i>' : '<i class="fas fa-user-tag" style="color:var(--visitante)"></i>';
                const dIn = new Date(f.horaInicial).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
                const dOut = f.horaFinal ? new Date(f.horaFinal).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
                const btnBaixa = f.status === 'Aberto' ? `<button onclick="baixaVeiculo('${f.id}')" class="action-btn btn-baixa"><i class="fas fa-sign-out-alt"></i></button>` : '<i class="fas fa-check" style="color:var(--success); margin-right:5px"></i>';
                let btnExcluir = ''; if (currentUserRole === 'admin') btnExcluir = `<button onclick="deletarVeiculo('${f.id}')" class="action-btn btn-delete" title="Excluir"><i class="fas fa-trash"></i></button>`;
                tr.innerHTML = `<td>${badge}</td><td><small>${icon} ${f.tipo}</small></td><td><strong>${f.motorista}</strong><br><small style="color:var(--text-secondary)">${f.contato||''}</small></td><td>${f.carro}</td><td>${f.setor||'-'}</td><td style="font-size:0.85rem">Ent: ${dIn}<br>Sai: ${dOut}</td><td style="min-width:140px">${btnBaixa}<button onclick="editarVeiculo('${f.id}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button>${btnExcluir}</td>`;
                tbody.appendChild(tr);
            });
        }
        
        window.baixaVeiculo = function(id) { 
            const km = prompt("KM de Saída (Opcional):", "0"); 
            if (km !== null) { update(ref(db, 'frota/' + id), { kmFinal: km, horaFinal: new Date().toISOString(), status: 'Fechado' }); } 
        }

        // --- 4. EVENTOS --- 
        const formEvento = document.getElementById('form-evento');
        formEvento.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('evento-id-edit').value;
            const id = idEdicao || Date.now();
            const novoEvento = { id: id, tipo: document.querySelector('input[name="tipoEvento"]:checked').value, nome: document.getElementById('evento-nome').value.toUpperCase(), organizador: document.getElementById('evento-organizador').value.toUpperCase(), data: document.getElementById('evento-data').value, publico: parseInt(document.getElementById('evento-publico').value) || 0, local: document.getElementById('evento-local').value.toUpperCase(), coffee: document.getElementById('evento-coffee').checked, obs: document.getElementById('evento-obs').value.toUpperCase() };
            set(ref(db, 'eventos/' + id), novoEvento).then(() => { cancelarEdicaoEvento(); }).catch((error) => alert("Erro ao salvar evento: " + error));
        });
        
        onValue(ref(db, 'eventos'), (snapshot) => {
            const data = snapshot.val();
            eventos = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
            eventos.sort((a,b) => new Date(b.data) - new Date(a.data)); window.renderizarApenasEventos();
        });
        
        window.editarEvento = function(id) {
            const ev = eventos.find(item => String(item.id) === String(id)); if (!ev) return;
            document.getElementById('evento-id-edit').value = ev.id; document.getElementById('evento-nome').value = ev.nome; document.getElementById('evento-organizador').value = ev.organizador; document.getElementById('evento-data').value = ev.data; document.getElementById('evento-publico').value = ev.publico; document.getElementById('evento-local').value = ev.local; document.getElementById('evento-coffee').checked = ev.coffee || false; document.getElementById('evento-obs').value = ev.obs || "";
            const radios = document.getElementsByName('tipoEvento'); for(let i=0; i<radios.length; i++) { if(radios[i].value === ev.tipo) radios[i].checked = true; }
            document.getElementById('titulo-form-evento').innerHTML = '<i class="fas fa-edit"></i> Editando Evento'; 
            const btn = document.getElementById('btn-submit-evento'); btn.innerText = "Salvar Alterações"; btn.style.backgroundColor = "var(--edit)"; 
            document.getElementById('btn-cancel-evento').style.display = "block"; document.getElementById('eventos').scrollIntoView({behavior: 'smooth'});
        }
        
        window.cancelarEdicaoEvento = function() { 
            document.getElementById('evento-id-edit').value = ""; formEvento.reset(); 
            document.getElementById('evento-data').valueAsDate = new Date(); document.getElementById('evento-coffee').checked = false; document.getElementById('evento-obs').value = ""; 
            document.getElementById('titulo-form-evento').innerHTML = '<i class="fas fa-calendar-plus" style="color:var(--evento)"></i> Registrar Evento'; 
            const btn = document.getElementById('btn-submit-evento'); btn.innerText = "Salvar Evento"; btn.style.backgroundColor = "var(--evento)"; 
            document.getElementById('btn-cancel-evento').style.display = "none"; 
        }
        
        window.deletarEvento = function(id) { 
            if(confirm('Tem certeza que deseja EXCLUIR este evento?')) { 
                remove(ref(db, 'eventos/' + id)); 
                if(document.getElementById('evento-id-edit').value == id) cancelarEdicaoEvento(); 
            } 
        }
        
        window.renderizarApenasEventos = function() {
            const mes = document.getElementById('filtro-mes-evento').value; 
            const busca = document.getElementById('filtro-busca-evento').value.toLowerCase();
            const lista = eventos.filter(ev => { 
                const bData = !mes || ev.data.startsWith(mes); 
                const bTexto = !busca || (ev.nome + ev.organizador + ev.local).toLowerCase().includes(busca); return bData && bTexto; 
            });
            document.getElementById('dash-eventos-qtd').innerText = lista.length; 
            const qtdInterno = lista.filter(e => e.tipo === 'Interno').length; const qtdExterno = lista.filter(e => e.tipo === 'Externo').length; 
            document.getElementById('dash-eventos-interno').innerText = qtdInterno; document.getElementById('dash-eventos-externo').innerText = qtdExterno; 
            const totalPublico = lista.reduce((sum, ev) => sum + (parseInt(ev.publico) || 0), 0); document.getElementById('dash-eventos-publico').innerText = totalPublico;
            const tbody = document.querySelector('#tabela-eventos tbody'); tbody.innerHTML = '';
            lista.forEach(ev => {
                const tr = document.createElement('tr'); 
                const badgeClass = ev.tipo === 'Interno' ? 'bg-interno' : 'bg-externo'; 
                const badge = `<span class="badge ${badgeClass}">${ev.tipo}</span>`; 
                const iconCoffee = ev.coffee ? '<i class="fas fa-coffee" title="Terá Coffee Break" style="color:var(--coffee); margin-left:5px"></i>' : ''; 
                const obsText = ev.obs ? `<div style="font-size:0.75rem; color:#6b7280; font-style:italic; margin-top:4px; padding-top:4px; border-top:1px dashed #e5e7eb"><i class="fas fa-comment-alt" style="font-size:0.7rem"></i> ${ev.obs}</div>` : '';
                let btnExcluir = ''; if (currentUserRole === 'admin') { btnExcluir = `<button onclick="deletarEvento('${ev.id}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button>`; }
                tr.innerHTML = `<td>${formatarData(ev.data)}</td><td>${badge}</td><td><strong>${ev.nome}</strong>${iconCoffee}<br><small style="color:var(--text-secondary)">${ev.local}</small>${obsText}</td><td>${ev.organizador}</td><td><i class="fas fa-user"></i> ${ev.publico}</td><td style="min-width:100px"><button onclick="editarEvento('${ev.id}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button>${btnExcluir}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- 5. OCORRÊNCIAS --- 
        const formOcorrencia = document.getElementById('form-ocorrencia');
        formOcorrencia.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('ocorrencia-id-edit').value;
            const id = idEdicao || Date.now();
            const statusNovo = idEdicao ? document.getElementById('oco-status-edit').value : 'Aberta';
            const novaOcorrencia = { id: id, unidade: document.getElementById('oco-unidade').value.toUpperCase(), local: document.getElementById('oco-local').value.toUpperCase(), categoria: document.getElementById('oco-categoria').value, gravidade: document.getElementById('oco-gravidade').value, data: document.getElementById('oco-data').value, responsavel: document.getElementById('oco-responsavel').value.toUpperCase(), descricao: document.getElementById('oco-descricao').value.toUpperCase(), status: statusNovo, dataEncerramento: null };
            if(idEdicao) {
                const ant = ocorrencias.find(o => String(o.id) === String(id));
                if(statusNovo === 'Encerrada' && (!ant || ant.status !== 'Encerrada')) novaOcorrencia.dataEncerramento = new Date().toISOString();
                else if(ant && ant.dataEncerramento && statusNovo === 'Encerrada') novaOcorrencia.dataEncerramento = ant.dataEncerramento;
            }
            set(ref(db, 'ocorrencias/' + id), novaOcorrencia).then(() => cancelarEdicaoOcorrencia()).catch(e => alert(e));
        });
        
        onValue(ref(db, 'ocorrencias'), (snap) => {
            const data = snap.val();
            ocorrencias = data ? Object.keys(data).map(k => ({...data[k], id: k})) : [];
            ocorrencias.sort((a,b) => new Date(b.data) - new Date(a.data)); window.renderizarApenasOcorrencias();
        });
        
        window.editarOcorrencia = function(id) {
            const o = ocorrencias.find(i => String(i.id) === String(id)); if(!o) return;
            document.getElementById('ocorrencia-id-edit').value = o.id; document.getElementById('oco-unidade').value = o.unidade; document.getElementById('oco-local').value = o.local; document.getElementById('oco-categoria').value = o.categoria; document.getElementById('oco-gravidade').value = o.gravidade; document.getElementById('oco-data').value = o.data; document.getElementById('oco-responsavel').value = o.responsavel; document.getElementById('oco-descricao').value = o.descricao;
            document.getElementById('titulo-form-ocorrencia').innerHTML = '<i class="fas fa-edit"></i> Editando Ocorrência'; document.getElementById('btn-submit-oco').innerText = "Salvar Alterações"; document.getElementById('btn-cancel-oco').style.display = "block"; document.getElementById('div-status-oco').style.display = "block"; document.getElementById('oco-status-edit').value = o.status;
            document.getElementById('ocorrencias').scrollIntoView({behavior:'smooth'});
        }
        
        window.cancelarEdicaoOcorrencia = function() {
            document.getElementById('ocorrencia-id-edit').value = ""; formOcorrencia.reset(); document.getElementById('oco-data').value = getLocalISO();
            document.getElementById('titulo-form-ocorrencia').innerHTML = '<i class="fas fa-exclamation-triangle" style="color:var(--ocorrencia)"></i> Registrar Ocorrência'; document.getElementById('btn-submit-oco').innerText = "Registrar Ocorrência"; document.getElementById('btn-cancel-oco').style.display = "none"; document.getElementById('div-status-oco').style.display = "none";
        }
        
        window.deletarOcorrencia = function(id) { 
            if(currentUserRole !== 'admin') { alert('Apenas administradores podem excluir.'); return; } 
            if(confirm('Excluir ocorrência?')) remove(ref(db, 'ocorrencias/'+id)); 
        }
        
        window.renderizarApenasOcorrencias = function() {
            const mes = document.getElementById('filtro-mes-oco').value; 
            const termo = document.getElementById('filtro-busca-oco').value.toLowerCase(); 
            const stat = document.getElementById('filtro-status-oco').value;
            const lista = ocorrencias.filter(o => { 
                const bMes = !mes || o.data.startsWith(mes); 
                const bStat = !stat || o.status === stat; 
                const bTxt = !termo || (o.unidade+o.local+o.categoria+o.descricao+o.responsavel).toLowerCase().includes(termo); return bMes && bStat && bTxt; 
            });
            document.getElementById('dash-oco-total').innerText = lista.length; document.getElementById('dash-oco-abertas').innerText = lista.filter(o => o.status === 'Aberta').length; document.getElementById('dash-oco-tratativa').innerText = lista.filter(o => o.status === 'Em Tratativa').length; document.getElementById('dash-oco-encerradas').innerText = lista.filter(o => o.status === 'Encerrada').length;
            const tbody = document.querySelector('#tabela-ocorrencias tbody'); tbody.innerHTML = '';
            lista.forEach(o => {
                const tr = document.createElement('tr');
                const gravMap = {'Baixa':'bg-baixa','Média':'bg-media','Alta':'bg-alta','Crítica':'bg-critica'}; const badgeGrav = `<span class="badge ${gravMap[o.gravidade]||'bg-pendente'}">${o.gravidade}</span>`;
                const statMap = {'Aberta':'bg-estacionado','Em Tratativa':'bg-andamento','Encerrada':'bg-concluido'}; const badgeStat = `<span class="badge ${statMap[o.status]}">${o.status}</span>`;
                const tempo = o.status === 'Encerrada' && o.dataEncerramento ? `<span class="time-badge"><i class="fas fa-check"></i> ${calcularTempoDecorrido(o.data, o.dataEncerramento)}</span>` : `<span class="time-badge"><i class="fas fa-clock"></i> ${calcularTempoDecorrido(o.data)}</span>`;
                let btnExcluir = currentUserRole === 'admin' ? `<button onclick="deletarOcorrencia('${o.id}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button>` : '';
                tr.innerHTML = `<td>${formatarDataHora(o.data)}</td><td>${badgeGrav}</td><td><strong>${o.categoria}</strong><br><small>${o.unidade} - ${o.local}</small></td><td>${o.descricao.substring(0,50)}...<br><small style="color:var(--text-secondary)">Resp: ${o.responsavel}</small></td><td>${badgeStat}</td><td>${tempo}</td><td style="min-width:100px"><button onclick="editarOcorrencia('${o.id}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button>${btnExcluir}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- FUNÇÃO DE IMPRESSÃO (NOVA: INJEÇÃO DIRETA NO DOM PARA CELULAR) ---
        window.imprimirOS = function(id) {
            const d = demandas.find(item => String(item.id) === String(id));
            if (!d) return;

            const dataAbertura = new Date(d.data).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
            const numeroOS = d.numeroOS || d.id.toString().slice(-4); 
            
            const textoExecucao = d.execucao ? d.execucao.replace(/\n/g, '<br>') : '';
            const textoMateriais = d.materiais ? d.materiais.replace(/\n/g, '<br>') : '';
            
            let baseUrl = window.location.href;
            if (baseUrl.includes('index.html')) baseUrl = baseUrl.replace('index.html', '');
            if (!baseUrl.endsWith('/')) baseUrl += '/';
            const logoSrc = baseUrl + 'brasaosp.jpg';
            
            // Criando uma área escondida dentro do próprio site para imprimir sem usar popups
            let printArea = document.getElementById('print-area');
            if (!printArea) {
                printArea = document.createElement('div');
                printArea.id = 'print-area';
                printArea.style.display = 'none';
                document.body.appendChild(printArea);
            }
            
            printArea.innerHTML = `
                <style>
                    @media print {
                        body > *:not(#print-area) { display: none !important; }
                        #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: #fff; z-index: 99999; }
                        @page { size: A4 portrait; margin: 12mm; }
                        body { background: #fff !important; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        
                        .os-print-wrapper { font-family: 'Arial', sans-serif; font-size: 11px; color: #000; width: 100%; line-height: 1.3; }
                        .os-print-wrapper .os-container { width: 100%; border: 2px solid #000; padding: 2px; box-sizing: border-box; }
                        .os-print-wrapper table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
                        .os-print-wrapper th, .os-print-wrapper td { border: 1px solid #000; padding: 5px 6px; text-align: left; vertical-align: top; font-size: 11px; }
                        .os-print-wrapper .bg-gray { background-color: #e5e7eb !important; font-weight: bold; text-transform: uppercase; font-size: 10px; color: #333; }
                        .os-print-wrapper .text-center { text-align: center; }
                        .os-print-wrapper .header-title { font-size: 14px; font-weight: bold; text-transform: uppercase; margin: 4px 0; }
                        .os-print-wrapper .header-subtitle { font-size: 11px; font-weight: bold; }
                        .os-print-wrapper .value-text { font-size: 12px; margin-top: 3px; display: block; text-transform: uppercase; color: #000; font-weight: normal; }
                        .os-print-wrapper .section-title { background-color: #d1d5db !important; font-weight: bold; text-align: center; font-size: 11px; padding: 4px; text-transform: uppercase; border: 1px solid #000; border-bottom: none; border-top: 2px solid #000; }
                        .os-print-wrapper .signatures { display: flex; width: 100%; }
                        .os-print-wrapper .signature-box { flex: 1; text-align: center; padding: 30px 5px 5px 5px; border: 1px solid #000; border-top: none; }
                        .os-print-wrapper .signature-line { border-top: 1px solid #000; width: 80%; margin: 30px auto 4px auto; }
                        .os-print-wrapper .checkbox-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 4px; font-size: 11px; text-transform: uppercase; }
                        .os-print-wrapper .checkbox-grid-3 { grid-template-columns: repeat(3, 1fr); }
                        .os-print-wrapper .checkbox-item { display: flex; align-items: center; gap: 4px; }
                        .os-print-wrapper .box { display: inline-block; width: 10px; height: 10px; border: 1px solid #000; }
                        .os-print-wrapper .footer-note { font-size: 9px; text-align: center; margin-top: 8px; font-style: italic; color: #555; }
                    }
                </style>
                <div class="os-print-wrapper">
                    <div class="os-container">
                        <table>
                            <tr>
                                <td width="15%" class="text-center" style="vertical-align: middle;">
                                    <img src="${logoSrc}" style="width: 65px; height: auto;" alt="Governo SP">
                                </td>
                                <td width="70%" class="text-center" style="vertical-align: middle;">
                                    <div class="header-title">GOVERNO DO ESTADO DE SÃO PAULO</div>
                                    <div class="header-subtitle">SECRETARIA DA EDUCAÇÃO</div>
                                    <div class="header-subtitle">COORDENADORIA GERAL DE SUPORTE ADMINISTRATIVO - DIVISÃO DE ZELADORIA</div>
                                </td>
                                <td width="15%" class="text-center" style="vertical-align: middle; background-color: #e5e7eb;">
                                    <span style="font-size: 10px; font-weight: bold;">ORDEM DE SERVIÇO</span><br>
                                    <span style="font-size: 18px; font-weight: bold; color: #dc2626;">Nº ${numeroOS}</span>
                                </td>
                            </tr>
                        </table>

                        <div class="section-title">1. IDENTIFICAÇÃO DA SOLICITAÇÃO</div>
                        <table>
                            <tr>
                                <td width="30%" class="bg-gray">DATA E HORA DE ABERTURA<span class="value-text">${dataAbertura}</span></td>
                                <td width="40%" class="bg-gray">SOLICITANTE / CONTATO<span class="value-text">${d.solicitante}</span></td>
                                <td width="30%" class="bg-gray">PRIORIDADE NO SISTEMA<span class="value-text">${d.prioridade}</span></td>
                            </tr>
                            <tr>
                                <td colspan="2" class="bg-gray">UNIDADE / SETOR DE ORIGEM<span class="value-text">${d.setor}</span></td>
                                <td class="bg-gray">STATUS ATUAL<span class="value-text">${d.status}</span></td>
                            </tr>
                        </table>

                        <div class="section-title">2. DESCRIÇÃO DA DEMANDA (PREENCHIMENTO PELO SISTEMA)</div>
                        <table>
                            <tr>
                                <td style="height: 50px; vertical-align: middle;">
                                    <span style="font-size: 13px; text-transform: uppercase; font-weight: bold;">${d.titulo}</span>
                                </td>
                            </tr>
                        </table>

                        <div class="section-title">3. PARECER TÉCNICO E EXECUÇÃO (PREENCHIMENTO PELA EQUIPE)</div>
                        <table>
                            <tr>
                                <td colspan="2" class="bg-gray">EQUIPE RESPONSÁVEL / CONTRATADA ATRIBUÍDA</td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div class="checkbox-grid checkbox-grid-3">
                                        <div class="checkbox-item"><div class="box"></div> LIMPEZA PREDIAL</div>
                                        <div class="checkbox-item"><div class="box"></div> AR CONDICIONADO</div>
                                        <div class="checkbox-item"><div class="box"></div> MANUTENÇÃO PREDIAL</div>
                                        <div class="checkbox-item"><div class="box"></div> MANUTENÇÃO DE ELEVADORES</div>
                                        <div class="checkbox-item"><div class="box"></div> SUPORTE TI</div>
                                        <div class="checkbox-item"><div class="box"></div> TELEFONIA</div>
                                        <div class="checkbox-item"><div class="box"></div> OUTRO: ___________________________</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2" class="bg-gray">LOCAL DE ATUAÇÃO / PRÉDIO VINCULADO</td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div class="checkbox-grid">
                                        <div class="checkbox-item"><div class="box"></div> SEDE</div>
                                        <div class="checkbox-item"><div class="box"></div> AROUCHE</div>
                                        <div class="checkbox-item"><div class="box"></div> EFAPE</div>
                                        <div class="checkbox-item"><div class="box"></div> ARMÊNIA</div>
                                        <div class="checkbox-item"><div class="box"></div> CASA VERDE</div>
                                        <div class="checkbox-item"><div class="box"></div> SÃO DOMINGOS</div>
                                        <div class="checkbox-item"><div class="box"></div> CAJAMAR</div>
                                        <div class="checkbox-item"><div class="box"></div> TENENTE PENA</div>
                                        <div class="checkbox-item"><div class="box"></div> CENTRO OESTE</div>
                                        <div class="checkbox-item"><div class="box"></div> CAPE</div>
                                        <div class="checkbox-item" style="grid-column: span 2;"><div class="box"></div> OUTRO: ___________________________</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td width="50%" class="bg-gray">DESCRIÇÃO DETALHADA DOS SERVIÇOS EXECUTADOS</td>
                                <td width="50%" class="bg-gray">MATERIAIS E PEÇAS UTILIZADOS (REPOSIÇÃO)</td>
                            </tr>
                            <tr>
                                <td style="height: 220px; font-weight: normal; font-size: 11px;">${textoExecucao}</td>
                                <td style="height: 220px; font-weight: normal; font-size: 11px;">${textoMateriais}</td>
                            </tr>
                        </table>

                        <div class="section-title">4. TERMO DE ENCERRAMENTO E ACEITE FISCAL</div>
                        <table>
                            <tr>
                                <td width="25%" class="bg-gray text-center">INÍCIO DO ATENDIMENTO<br><br><span style="font-weight: normal; font-size: 12px;">____/____/20____ às ____:____</span></td>
                                <td width="25%" class="bg-gray text-center">TÉRMINO DO ATENDIMENTO<br><br><span style="font-weight: normal; font-size: 12px;">____/____/20____ às ____:____</span></td>
                                <td width="50%" class="bg-gray">OBSERVAÇÕES FINAIS / PENDÊNCIAS<br><br><br></td>
                            </tr>
                        </table>
                        
                        <div class="signatures">
                            <div class="signature-box" style="border-left: 1px solid #000;">
                                <div class="signature-line"></div>
                                <strong>TÉCNICO EXECUTOR</strong><br>
                                <span style="font-size: 9px; font-weight: normal; color: #444;">Nome legível / Matrícula / Empresa</span>
                            </div>
                            <div class="signature-box" style="border-left: 1px solid #000; border-right: 1px solid #000;">
                                <div class="signature-line"></div>
                                <strong>GESTOR / FISCAL (DZEL)</strong><br>
                                <span style="font-size: 9px; font-weight: normal; color: #444;">Carimbo e Assinatura</span>
                            </div>
                            <div class="signature-box" style="border-right: 1px solid #000;">
                                <div class="signature-line"></div>
                                <strong>SOLICITANTE / RECEBEDOR</strong><br>
                                <span style="font-size: 9px; font-weight: normal; color: #444;">Atesto a conformidade do serviço</span>
                            </div>
                        </div>
                    </div>
                    <div class="footer-note">
                        Documento impresso através do Sistema de Gestão Predial (DZEL/SEDUC) em ${new Date().toLocaleString('pt-BR')}
                    </div>
                </div>
            `;
            
            // Força a chamada nativa do sistema do celular
            const img = printArea.querySelector('img');
            if (img) {
                img.onload = () => setTimeout(() => window.print(), 200);
                img.onerror = () => setTimeout(() => window.print(), 200);
            } else {
                setTimeout(() => window.print(), 200);
            }
        }

        /* --- EXPORTAÇÃO --- */
        window.exportarParaExcel = function(tipo) {
            let dadosRaw = []; let nomeArquivo = ""; let dadosFormatados = [];
            
            if (tipo === 'demandas') { 
                dadosRaw = demandas; nomeArquivo = "Relatorio_Demandas.xlsx"; 
                dadosFormatados = dadosRaw.map(d => ({ "Data": formatarData(d.data), "O.S.": d.numeroOS || "-", "Prioridade": d.prioridade, "Título": d.titulo, "Setor": d.setor, "Solicitante": d.solicitante, "Execução": d.execucao || "-", "Materiais Utilizados": d.materiais || "-", "Status": d.status, "Conclusão": d.dataFim ? formatarDataHora(d.dataFim) : "-" })); 
            } else if (tipo === 'visitantes') { 
                dadosRaw = visitantes; nomeArquivo = "Relatorio_Visitantes.xlsx"; 
                dadosFormatados = dadosRaw.map(v => ({ "Status": v.status, "Nome": v.nome, "Empresa": v.empresa || '-', "Responsável": v.responsavel, "Finalidade": v.finalidade, "Entrada": formatarDataHora(v.entrada), "Saída": v.saida ? formatarDataHora(v.saida) : "-" })); 
            } else if (tipo === 'veiculos') { 
                dadosRaw = frota; nomeArquivo = "Relatorio_Garagem.xlsx"; 
                dadosFormatados = dadosRaw.map(f => ({ "Status": f.status, "Tipo": f.tipo, "Condutor": f.motorista, "Veículo": f.carro, "Setor/Destino": f.setor, "Entrada": formatarDataHora(f.horaInicial), "KM Entrada": f.kmInicial, "Saída": f.horaFinal ? formatarDataHora(f.horaFinal) : "-", "KM Saída": f.kmFinal || "-" })); 
            } else if (tipo === 'eventos') { 
                dadosRaw = eventos; nomeArquivo = "Relatorio_Eventos.xlsx"; 
                dadosFormatados = dadosRaw.map(e => ({ "Data": formatarData(e.data), "Evento": e.nome, "Tipo": e.tipo, "Organizador": e.organizador, "Local": e.local, "Público Est.": e.publico, "Coffee Break": e.coffee ? "Sim" : "Não", "Observações": e.obs })); 
            } else if (tipo === 'ocorrencias') { 
                dadosRaw = ocorrencias; nomeArquivo = "Relatorio_Ocorrencias.xlsx"; 
                dadosFormatados = dadosRaw.map(o => ({ "Data": formatarDataHora(o.data), "Unidade": o.unidade, "Local": o.local, "Categoria": o.categoria, "Gravidade": o.gravidade, "Descrição": o.descricao, "Responsável": o.responsavel, "Status": o.status, "Encerramento": o.dataEncerramento ? formatarDataHora(o.dataEncerramento) : "-" })); 
            }
            
            if (dadosFormatados.length === 0) { alert("Não há dados para exportar nesta tabela."); return; }
            const ws = XLSX.utils.json_to_sheet(dadosFormatados); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Dados"); 
            XLSX.writeFile(wb, nomeArquivo);
        }
    </script>
</body>
</html>
